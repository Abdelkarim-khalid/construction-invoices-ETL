Project Code Collection
Root: F:\EPR Invoice\construction_backend
==================================================


==================================================
FILE: alembic.ini
==================================================
# A generic, single database configuration.

[alembic]
# path to migration scripts.
# this is typically a path given in POSIX (e.g. forward slashes)
# format, relative to the token %(here)s which refers to the location of this
# ini file
script_location = %(here)s/alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.  for multiple paths, the path separator
# is defined by "path_separator" below.
prepend_sys_path = .


# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the tzdata library which can be installed by adding
# `alembic[tz]` to the pip requirements.
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to <script_location>/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "path_separator"
# below.
# version_locations = %(here)s/bar:%(here)s/bat:%(here)s/alembic/versions

# path_separator; This indicates what character is used to split lists of file
# paths, including version_locations and prepend_sys_path within configparser
# files such as alembic.ini.
# The default rendered in new alembic.ini files is "os", which uses os.pathsep
# to provide os-dependent path splitting.
#
# Note that in order to support legacy alembic.ini files, this default does NOT
# take place if path_separator is not present in alembic.ini.  If this
# option is omitted entirely, fallback logic is as follows:
#
# 1. Parsing of the version_locations option falls back to using the legacy
#    "version_path_separator" key, which if absent then falls back to the legacy
#    behavior of splitting on spaces and/or commas.
# 2. Parsing of the prepend_sys_path option falls back to the legacy
#    behavior of splitting on spaces, commas, or colons.
#
# Valid values for path_separator are:
#
# path_separator = :
# path_separator = ;
# path_separator = space
# path_separator = newline
#
# Use os.pathsep. Default configuration used for new projects.
path_separator = os

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

# database URL.  This is consumed by the user-maintained env.py script only.
# other means of configuring database URLs may be customized within the env.py
# file.
sqlalchemy.url = sqlite:///construction_system.db

[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the module runner, against the "ruff" module
# hooks = ruff
# ruff.type = module
# ruff.module = ruff
# ruff.options = check --fix REVISION_SCRIPT_FILENAME

# Alternatively, use the exec runner to execute a binary found on your PATH
# hooks = ruff
# ruff.type = exec
# ruff.executable = ruff
# ruff.options = check --fix REVISION_SCRIPT_FILENAME

# Logging configuration.  This is also consumed by the user-maintained
# env.py script only.
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARNING
handlers = console
qualname =

[logger_sqlalchemy]
level = WARNING
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S


==================================================
FILE: check_db.py
==================================================
from sqlalchemy import create_engine, inspect, text
from database import DATABASE_URL

def check_database():
    print(f"Checking database at: {DATABASE_URL}")
    engine = create_engine(DATABASE_URL)
    inspector = inspect(engine)
    
    tables = inspector.get_table_names()
    print(f"\nFound {len(tables)} tables:")
    
    for table in tables:
        print(f"\nğŸ“‹ Table: {table}")
        columns = inspector.get_columns(table)
        # Print columns
        col_names = [col['name'] for col in columns]
        print(f"   Columns: {', '.join(col_names)}")
        
        # Print first 5 rows
        with engine.connect() as conn:
            result = conn.execute(text(f"SELECT * FROM {table} LIMIT 5"))
            rows = result.fetchall()
            if rows:
                print("   DATA (First 5 rows):")
                for row in rows:
                    print(f"   -> {row}")
            else:
                print("   -> [Empty Table]")

if __name__ == "__main__":
    check_database()


==================================================
FILE: database.py
==================================================
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, declarative_base

SQLITE_FILE_NAME = "construction_system.db"
DATABASE_URL = f"sqlite:///{SQLITE_FILE_NAME}"

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±Ùƒ (connect_args Ù…Ù‡Ù…Ø© Ø¹Ø´Ø§Ù† SQLite ÙŠÙ‚Ø¨Ù„ ØªØ¹Ø¯Ø¯ Ø§Ù„Ù€ Threads)
engine = create_engine(DATABASE_URL, connect_args={"check_same_thread": False})

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()

# Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù„Ø³Ø© Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ù„ÙƒÙ„ Request
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


==================================================
FILE: frontend.py
==================================================
import streamlit as st
import pandas as pd
import requests
from datetime import date
import io
import string

# ==========================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©
# ==========================================
st.set_page_config(page_title="Mini ERP - Construction", layout="wide")
API_URL = "http://127.0.0.1:8000"

# --- Helper Functions ---
def get_col_letter(n):
    string_n = ""
    while n >= 0:
        n, remainder = divmod(n, 26)
        string_n = chr(65 + remainder) + string_n
        n -= 1
    return string_n

@st.cache_data(ttl=60)
def fetch_projects_list():
    try:
        res = requests.get(f"{API_URL}/projects/")
        if res.status_code == 200:
            return {f"{p['name']} (ID: {p['id']})": p['id'] for p in res.json()}
        return {}
    except:
        return {}

def reset_wizard():
    st.session_state.step = 1
    st.session_state.uploaded_file = None
    st.session_state.sheet_civil = None
    st.session_state.sheet_elec = None

if 'step' not in st.session_state: st.session_state.step = 1
if 'mapping_civil' not in st.session_state: st.session_state.mapping_civil = {}
if 'mapping_elec' not in st.session_state: st.session_state.mapping_elec = {}
if 'header_index' not in st.session_state: st.session_state.header_index = 0
if 'wiz_invoice_no' not in st.session_state: st.session_state.wiz_invoice_no = 1

# ==========================================
# 2. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar)
# ==========================================
st.sidebar.title("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")
menu = st.sidebar.radio(
    "ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª:",
    ["1. ØªØ£Ø³ÙŠØ³ Ù…Ø´Ø±ÙˆØ¹", "2. Ù…Ø¹Ø§Ù„Ø¬ Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª (Wizard)", "3. Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"],
    on_change=reset_wizard 
)

# ==========================================
# Ø§Ù„ØµÙØ­Ø© 1: ØªØ£Ø³ÙŠØ³ Ù…Ø´Ø±ÙˆØ¹
# ==========================================
if menu == "1. ØªØ£Ø³ÙŠØ³ Ù…Ø´Ø±ÙˆØ¹":
    st.header("ğŸ› ï¸ ØªØ£Ø³ÙŠØ³ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹")
    tab1, tab2 = st.tabs(["Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯", "Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯"])
    
    with tab1:
        with st.form("new_proj"):
            name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")
            loc = st.text_input("Ø§Ù„Ù…ÙˆÙ‚Ø¹")
            if st.form_submit_button("Ø­ÙØ¸") and name:
                try:
                    res = requests.post(f"{API_URL}/projects/", json={"name": name, "location": loc})
                    if res.status_code == 200: 
                        st.success("ØªÙ… Ø§Ù„Ø­ÙØ¸!")
                        fetch_projects_list.clear()
                    else: st.error(f"Ø®Ø·Ø£: {res.text}")
                except Exception as e: st.error(f"Ø§Ø³ØªØ«Ù†Ø§Ø¡: {str(e)}")

    with tab2:
        proj_map = fetch_projects_list()
        if proj_map:
            sel_proj = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", proj_map.keys())
            pid = proj_map[sel_proj]
            with st.form("new_item"):
                c1, c2 = st.columns(2)
                code = c1.text_input("ÙƒÙˆØ¯ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: 9-2)")
                unit = c1.text_input("Ø§Ù„ÙˆØ­Ø¯Ø©")
                price = c1.number_input("Ø§Ù„ÙØ¦Ø©", min_value=0.0)
                desc = c2.text_area("Ø§Ù„ÙˆØµÙ")
                partial = c2.checkbox("Ù…Ø¬Ø²Ø£ØŸ")
                if st.form_submit_button("Ø¥Ø¶Ø§ÙØ©"):
                    try:
                        res = requests.post(f"{API_URL}/boq/{pid}", json={
                            "item_code": code, "description": desc,
                            "unit": unit, "unit_price": price, "is_partial": partial
                        })
                        if res.status_code == 200:
                            st.success(f"ØªÙ… Ø¥Ø¶Ø§ÙØ© {code}")
                        else:
                            st.error(f"ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: {res.text}")
                    except Exception as e: st.error(f"Ø®Ø·Ø£ Ø§ØªØµØ§Ù„: {e}")
        else:
            st.warning("ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹.")

# ==========================================
# Ø§Ù„ØµÙØ­Ø© 2: Ù…Ø¹Ø§Ù„Ø¬ Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª (Wizard)
# ==========================================
elif menu == "2. Ù…Ø¹Ø§Ù„Ø¬ Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª (Wizard)":
    st.header("ğŸ“¤ Ø±ÙØ¹ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª")
    progress = (st.session_state.step / 3) * 100
    st.progress(int(progress))

    # --- Ø§Ù„Ø®Ø·ÙˆØ© 1 ---
    if st.session_state.step == 1:
        st.subheader("Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´ÙŠØªØ§Øª")
        
        proj_map = fetch_projects_list()
        if not proj_map:
            st.warning("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹.")
            st.stop()
            
        st.session_state.selected_proj_name = st.selectbox(
            "Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", proj_map.keys(), 
            index=0 if 'selected_proj_name' not in st.session_state else list(proj_map.keys()).index(st.session_state.selected_proj_name)
        )
        
        c_inv, c_d1, c_d2 = st.columns([1, 1, 1])
        st.session_state.wiz_invoice_no = c_inv.number_input("Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ", min_value=1, value=st.session_state.wiz_invoice_no)
        st.session_state.start_date = c_d1.date_input("Ù…Ù† ØªØ§Ø±ÙŠØ®", value=date.today())
        st.session_state.end_date = c_d2.date_input("Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®", value=date.today())

        uploaded = st.file_uploader("Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ (Excel)", type=["xlsx", "xls"])
        
        if uploaded:
            st.session_state.uploaded_file = uploaded
            try:
                xl = pd.ExcelFile(uploaded)
                sheets = xl.sheet_names
                st.markdown("---")
                col_civ, col_elec = st.columns(2)
                with col_civ:
                    st.markdown("### ğŸ—ï¸ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©")
                    sheet_civ = st.selectbox("Ø´ÙŠØª Ø§Ù„Ù…Ø¯Ù†ÙŠ", ["-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ --"] + sheets)
                    st.session_state.sheet_civil = sheet_civ if sheet_civ != "-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ --" else None
                with col_elec:
                    st.markdown("### âš¡ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡")
                    sheet_elec = st.selectbox("Ø´ÙŠØª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡", ["-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ --"] + sheets)
                    st.session_state.sheet_elec = sheet_elec if sheet_elec != "-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ --" else None
            except Exception as e:
                st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù: {e}")

        st.markdown("---")
        col_back, col_space, col_next = st.columns([1, 6, 1])
        with col_back: st.button("â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚", disabled=True)
        with col_next:
            if st.button("Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸", use_container_width=True):
                if not st.session_state.get('uploaded_file'): st.error("ÙŠØ¬Ø¨ Ø±ÙØ¹ Ù…Ù„Ù!")
                elif not st.session_state.sheet_civil and not st.session_state.sheet_elec: st.error("Ø§Ø®ØªØ± Ø´ÙŠØª ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!")
                else:
                    st.session_state.step = 2
                    st.rerun()

    # --- Ø§Ù„Ø®Ø·ÙˆØ© 2 ---
    elif st.session_state.step == 2:
        st.subheader("Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©")
        
        header_row = st.number_input("ğŸ“ Ø±Ù‚Ù… ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„:", min_value=1, value=10)
        st.session_state.header_index = header_row - 1
        
        st.markdown("---")
        file = st.session_state.uploaded_file
        
        def draw_mapper(sheet_name, key_prefix):
            st.markdown(f"### ğŸ“‘ Ø´ÙŠØª: {sheet_name}")
            try:
                df = pd.read_excel(file, sheet_name=sheet_name, header=st.session_state.header_index)
                
                # --- Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª ---
                df.columns = df.columns.astype(str)
                # -------------------------
                
                st.write("Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:")
                st.dataframe(df.head(3))
                cols_options = [f"{get_col_letter(i)} - {str(col)}" for i, col in enumerate(df.columns)]
                c1, c2, c3, c4 = st.columns(4)
                mapping = {}
                mapping['item_code'] = c1.selectbox(f"Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø¯", cols_options, key=f"{key_prefix}_code")
                mapping['description'] = c2.selectbox(f"ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯", cols_options, key=f"{key_prefix}_desc")
                mapping['qty'] = c3.selectbox(f"Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©", cols_options, key=f"{key_prefix}_qty")
                mapping['percentage'] = c4.selectbox(f"Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ±Ù", cols_options, key=f"{key_prefix}_pct")
                return mapping, df
            except Exception as e:
                st.error(f"Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø´ÙŠØª: {e}")
                return None, None

        civil_df = None
        if st.session_state.sheet_civil:
            civil_map_ui, civil_df = draw_mapper(st.session_state.sheet_civil, "civ")
            st.session_state.mapping_civil = civil_map_ui
            st.markdown("---")

        elec_df = None
        if st.session_state.sheet_elec:
            elec_map_ui, elec_df = draw_mapper(st.session_state.sheet_elec, "elec")
            st.session_state.mapping_elec = elec_map_ui

        st.markdown("---")
        col_back, col_space, col_next = st.columns([1, 6, 2]) 
        with col_back:
            if st.button("â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚", use_container_width=True):
                st.session_state.step = 1
                st.rerun()
                
        with col_next:
            if st.button("Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ­ÙØ¸ âœ…", use_container_width=True):
                proj_map = fetch_projects_list()
                if not proj_map:
                    st.error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.")
                    st.stop()

                project_id = proj_map[st.session_state.selected_proj_name]
                
                # --- Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ®ØµØµ ---
                def send_sheet(dataframe, mapping, trade_arg):
                    if dataframe is None: return None, "No Data"
                    
                    clean_map = {k: v.split(" - ", 1)[1] for k, v in mapping.items()}
                    rename_dict = {
                        clean_map['item_code']: 'item_code',
                        clean_map['description']: 'description',
                        clean_map['qty']: 'qty',
                        clean_map['percentage']: 'percentage'
                    }
                    df_ready = dataframe.rename(columns=rename_dict)
                    
                    buffer = io.BytesIO()
                    try:
                        with pd.ExcelWriter(buffer, engine='xlsxwriter') as writer:
                            df_ready.to_excel(writer, index=False)
                    except:
                        df_ready.to_excel(buffer, index=False)
                    buffer.seek(0)
                    
                    files = {"file": ("processed.xlsx", buffer, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")}
                    
                    # Ù‡Ù†Ø§ Ù†Ø±Ø³Ù„ Ù†ÙˆØ¹ Ø§Ù„ØªØ®ØµØµ (civil / elec)
                    data = {
                        "project_id": project_id,
                        "invoice_number": st.session_state.wiz_invoice_no,
                        "start_date": st.session_state.start_date,
                        "end_date": st.session_state.end_date,
                        "sheet_name": 0,
                        "trade_type": trade_arg  # <--- Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹
                    }
                    
                    try:
                        res = requests.post(f"{API_URL}/upload-invoice/", files=files, data=data)
                        if res.status_code == 200:
                            return True, res.json().get("message", "ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­")
                        else:
                            # Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                            try:
                                err_details = res.json()
                                if "detail" in err_details:
                                    return False, f"Server Error: {err_details['detail']}"
                                return False, f"Unknown Error: {err_details}"
                            except:
                                return False, f"Raw Error ({res.status_code}): {res.text}"
                    except Exception as e:
                        return False, f"Connection Error: {str(e)}"

                # --- Ø§Ù„ØªÙ†ÙÙŠØ° ---
                errors_log = []
                success_log = []

                if st.session_state.sheet_civil:
                    is_ok, msg = send_sheet(civil_df, st.session_state.mapping_civil, "civil")
                    if is_ok: success_log.append(f"Ø§Ù„Ù…Ø¯Ù†ÙŠ: {msg}")
                    else: errors_log.append(f"âŒ Ø®Ø·Ø£ Ù…Ø¯Ù†ÙŠ: {msg}")

                if st.session_state.sheet_elec:
                    is_ok, msg = send_sheet(elec_df, st.session_state.mapping_elec, "elec")
                    if is_ok: success_log.append(f"Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡: {msg}")
                    else: errors_log.append(f"âŒ Ø®Ø·Ø£ ÙƒÙ‡Ø±Ø¨Ø§Ø¡: {msg}")

                # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                if errors_log:
                    for err in errors_log:
                        st.error(err)  # Ø³ÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ù…ÙØµÙ„Ø© Ù‡Ù†Ø§
                
                if success_log:
                    for s in success_log:
                        st.success(s)

                if not errors_log:
                    st.session_state.step = 1
                    st.info("âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ…Øª Ø¨Ù†Ø¬Ø§Ø­ ÙƒØ§Ù…Ù„. Ø§Ù†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.")

# ==========================================
# Ø§Ù„ØµÙØ­Ø© 3: Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
# ==========================================
elif menu == "3. Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±":
    st.header("ğŸ“Š Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±")
    tab_rev, tab_rep = st.tabs(["Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ø¹ØªÙ…Ø§Ø¯", "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"])
    
    with tab_rev:
        col_in, col_btn = st.columns([1, 2])
        iid = col_in.number_input("Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", value=1)
        
        if col_btn.button("Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"):
            try:
                res = requests.get(f"{API_URL}/invoices/{iid}/staging")
                if res.status_code == 200:
                    data = res.json()
                    if data:
                        df = pd.DataFrame(data)
                        
                        # ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                        def highlight_invalid(row):
                            return ['background-color: #ffcccc'] * len(row) if not row['is_valid'] else [''] * len(row)
                        
                        st.write(f"Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯: {len(df)}")
                        st.dataframe(df.style.apply(highlight_invalid, axis=1))
                    else: st.warning("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ.")
                else: st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨: {res.text}")
            except Exception as e: st.error(f"ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")
            
        if st.button("âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ù‡Ø§Ø¦ÙŠ"):
            try:
                res = requests.post(f"{API_URL}/invoices/{iid}/approve")
                if res.status_code == 200: st.success("ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯!")
                else: 
                    err = res.json().get('detail', res.text)
                    st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯: {err}")
            except Exception as e: st.error(f"ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")

    with tab_rep:
        proj_map = fetch_projects_list()
        if proj_map:
            sel_proj = st.selectbox("Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù„ØªÙ‚Ø±ÙŠØ±", proj_map.keys())
            pid = proj_map[sel_proj]
            c1, c2 = st.columns(2)
            month = c1.selectbox("Ø§Ù„Ø´Ù‡Ø±", range(1, 13))
            year = c2.number_input("Ø§Ù„Ø³Ù†Ø©", value=2025)
            if st.button("Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"):
                try:
                    res = requests.get(f"{API_URL}/reports/schedule/{pid}", params={"month": month, "year": year})
                    if res.status_code == 200:
                        data = res.json()
                        if data:
                            df = pd.DataFrame(data)
                            st.table(df)
                            st.bar_chart(df.set_index("item_code")['total_qty'])
                        else: st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.")
                    else: st.error(res.text)
                except: pass

==================================================
FILE: init_db.py
==================================================
"""
Ù…Ù„Ù Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·
Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠÙØ´ØºÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ Ø§Ø³ØªØ®Ø¯Ù… Alembic migrations Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
"""
from database import engine, Base
import models

def init_database():
    """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    print("ğŸš€ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
    Base.metadata.create_all(bind=engine)
    print("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
    print("âš ï¸ Ø§Ø­Ø°Ù Ø£Ùˆ Ø§Ø¹Ù…Ù„ comment Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„")

if __name__ == "__main__":
    init_database()


==================================================
FILE: main.py
==================================================
from typing import List
from fastapi import FastAPI, Depends, UploadFile, File, Form, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy.orm import Session
from sqlalchemy import func
from datetime import date, timedelta
import shutil
import os
import calendar

from database import get_db
import models
import schemas
from services.invoice_processor import process_excel_invoice, approve_invoice

app = FastAPI(title="Construction Cost Control API")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
def home():
    return {"message": "System is Running ğŸš€"}

# --- [ØªØ¹Ø¯ÙŠÙ„ ChatGPT Ø§Ù„Ù…Ù…ØªØ§Ø²: Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹] ---
@app.get("/projects/", response_model=List[schemas.ProjectRead])
def list_projects(db: Session = Depends(get_db)):
    projects = db.query(models.Project).all()
    # ØªØ­ÙˆÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
    return projects

@app.post("/projects/")
def create_project(project: schemas.ProjectCreate, db: Session = Depends(get_db)):
    new_project = models.Project(
        name=project.name,
        location=project.location
    )
    db.add(new_project)
    db.commit()
    db.refresh(new_project)
    return new_project

@app.post("/boq/{project_id}")
def add_boq_item(project_id: int, item: schemas.BOQItemCreate, db: Session = Depends(get_db)):
    project = db.query(models.Project).filter(models.Project.id == project_id).first()
    if not project:
        raise HTTPException(status_code=404, detail="Project not found")

    new_item = models.BOQItem(
        project_id=project_id,
        item_code=item.item_code,
        description=item.description,
        unit=item.unit,
        unit_price=item.unit_price,
        is_partial=item.is_partial,
    )
    db.add(new_item)
    db.commit()
    db.refresh(new_item)
    return new_item

@app.post("/upload-invoice/")
async def upload_invoice(
    project_id: int = Form(...),
    invoice_number: str = Form(...),
    start_date: date = Form(...),
    end_date: date = Form(...),
    sheet_name: str = Form(...), 
    trade_type: str = Form("general"),  # <--- Ø¥Ø¶Ø§ÙØ©: Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªØ®ØµØµ
    file: UploadFile = File(...),
    db: Session = Depends(get_db),
):
    os.makedirs("temp_uploads", exist_ok=True)
    file_path = os.path.join("temp_uploads", file.filename)

    with open(file_path, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)

    # ØªØ­ÙˆÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø´ÙŠØª Ù„Ø±Ù‚Ù… Ù„Ùˆ Ø£Ù…ÙƒÙ†
    final_sheet_name = sheet_name
    if str(sheet_name).isdigit():
        final_sheet_name = int(sheet_name)

    try:
        result = process_excel_invoice(
            db=db,
            project_id=project_id,
            file_path=file_path,
            inv_number=invoice_number,
            start_date=start_date,
            end_date=end_date,
            sheet_name=final_sheet_name,
            trade_type=trade_type,  # <--- ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªØ®ØµØµ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬
        )
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Error processing invoice: {str(e)}")

    return result

@app.get("/invoices/{invoice_id}/staging")
def get_invoice_staging(invoice_id: int, db: Session = Depends(get_db)):
    invoice = db.query(models.InvoiceLog).filter(models.InvoiceLog.id == invoice_id).first()
    if not invoice:
        raise HTTPException(status_code=404, detail="Invoice not found")

    rows = []
    for s in invoice.staging_data:
        rows.append({
            "row_index": s.row_index,
            "raw_item_code": s.raw_item_code,
            "raw_description": s.raw_description,
            "raw_qty": s.raw_qty,
            "raw_percentage": s.raw_percentage,
            "is_valid": s.is_valid,
            "error_message": s.error_message,
        })
    return rows

@app.post("/invoices/{invoice_id}/approve")
def approve_invoice_endpoint(invoice_id: int, db: Session = Depends(get_db)):
    try:
        result = approve_invoice(db, invoice_id)
        return result
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))

@app.get("/reports/schedule/{project_id}")
def schedule_report(
    project_id: int,
    month: int,
    year: int,
    db: Session = Depends(get_db),
):
    import calendar
    if month < 1 or month > 12:
        raise HTTPException(status_code=400, detail="Invalid month")
    
    last_day = calendar.monthrange(year, month)[1]
    start_date = date(year, month, 1)
    end_date = date(year, month, last_day)

    q = (
        db.query(
            models.BOQItem.item_code,
            models.BOQItem.description,
            func.sum(models.DailyLedger.distributed_qty).label("total_qty"),
        )
        .join(models.DailyLedger, models.DailyLedger.boq_item_id == models.BOQItem.id)
        .filter(
            models.DailyLedger.project_id == project_id,
            models.DailyLedger.entry_date >= start_date,
            models.DailyLedger.entry_date <= end_date,
        )
        .group_by(models.BOQItem.item_code, models.BOQItem.description)
        .all()
    )

    return [
        {
            "item_code": row.item_code,
            "description": row.description,
            "total_qty": float(row.total_qty) if row.total_qty is not None else 0.0,
        }
        for row in q
    ]

==================================================
FILE: models.py
==================================================
from sqlalchemy import Column, Integer, String, Float, Date, Boolean, ForeignKey, Text, Enum, UniqueConstraint
from sqlalchemy.orm import relationship
from database import Base
import enum

# =========================================================
# 1. Enums
# =========================================================
class InvoiceStatus(enum.Enum):
    DRAFT = "draft"
    REVIEW = "review"
    APPROVED = "approved"

# (Ø¬Ø¯ÙŠØ¯) ØªØ¹Ø±ÙŠÙ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªØ®ØµØµØ§Øª
class TradeType(enum.Enum):
    CIVIL = "civil"       # Ù…Ø¯Ù†ÙŠ
    ELEC = "elec"         # ÙƒÙ‡Ø±Ø¨Ø§Ø¡
    MECH = "mech"         # Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§
    ARCH = "arch"         # Ù…Ø¹Ù…Ø§Ø±ÙŠ
    GENERAL = "general"   # Ø¹Ø§Ù…

# =========================================================
# 2. Projects
# =========================================================
class Project(Base):
    __tablename__ = 'projects'
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, index=True)
    location = Column(String, nullable=True)
    
    boq_items = relationship("BOQItem", back_populates="project")
    invoices = relationship("InvoiceLog", back_populates="project")
    ledger_entries = relationship("DailyLedger", back_populates="project")

# =========================================================
# 3. BOQ Items
# =========================================================
class BOQItem(Base):
    __tablename__ = 'boq_items'
    id = Column(Integer, primary_key=True, index=True)
    project_id = Column(Integer, ForeignKey('projects.id'))
    item_code = Column(String, index=True)
    description = Column(String)
    unit = Column(String)
    unit_price = Column(Float, default=0.0)
    is_partial = Column(Boolean, default=False)
    
    project = relationship("Project", back_populates="boq_items")
    invoice_details = relationship("InvoiceDetail", back_populates="boq_item")
    ledger_entries = relationship("DailyLedger", back_populates="boq_item")

# =========================================================
# 4. Invoice Log
# =========================================================
class InvoiceLog(Base):
    __tablename__ = 'invoices_log'
    id = Column(Integer, primary_key=True, index=True)
    project_id = Column(Integer, ForeignKey('projects.id'))
    invoice_number = Column(Integer, index=True)
    status = Column(Enum(InvoiceStatus), default=InvoiceStatus.DRAFT)
    period_start = Column(Date)
    period_end = Column(Date)
    previous_invoice_id = Column(Integer, ForeignKey('invoices_log.id'), nullable=True)
    
    project = relationship("Project", back_populates="invoices")
    details = relationship("InvoiceDetail", back_populates="invoice")
    staging_data = relationship("StagingInvoiceDetail", back_populates="invoice")
    ledger_entries = relationship("DailyLedger", back_populates="invoice")
    previous_invoice = relationship("InvoiceLog", remote_side=[id])
    
    __table_args__ = (
        UniqueConstraint('project_id', 'invoice_number', name='uix_project_invoice_number'),
    )

# =========================================================
# 5. Staging Area (ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© trade)
# =========================================================
class StagingInvoiceDetail(Base):
    __tablename__ = 'staging_invoice_details'
    id = Column(Integer, primary_key=True, index=True)
    invoice_id = Column(Integer, ForeignKey('invoices_log.id'))
    row_index = Column(Integer)
    
    raw_item_code = Column(String, nullable=True)
    raw_description = Column(String, nullable=True)
    raw_qty = Column(String, nullable=True)
    raw_percentage = Column(String, nullable=True)
    
    # (ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
    trade = Column(Enum(TradeType), default=TradeType.GENERAL)

    is_valid = Column(Boolean, default=False)
    error_message = Column(Text, nullable=True)
    
    invoice = relationship("InvoiceLog", back_populates="staging_data")

# =========================================================
# 6. Invoice Details (ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© trade)
# =========================================================
class InvoiceDetail(Base):
    __tablename__ = 'invoice_details'
    id = Column(Integer, primary_key=True, index=True)
    invoice_id = Column(Integer, ForeignKey('invoices_log.id'))
    boq_item_id = Column(Integer, ForeignKey('boq_items.id'))
    
    row_description = Column(String, nullable=True)
    current_percentage = Column(Float, default=100.0)
    claimed_qty = Column(Float, default=0.0)
    approved_qty = Column(Float, default=0.0)
    equivalent_qty = Column(Float, default=0.0)
    
    previous_cumulative_qty = Column(Float, default=0.0)
    total_cumulative_qty = Column(Float, default=0.0)
    unit_price_at_time = Column(Float)
    total_value = Column(Float, default=0.0)
    notes = Column(Text)
    
    # (ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
    trade = Column(Enum(TradeType), default=TradeType.GENERAL)
    
    invoice = relationship("InvoiceLog", back_populates="details")
    boq_item = relationship("BOQItem", back_populates="invoice_details")

# =========================================================
# 7. Daily Ledger
# =========================================================
class DailyLedger(Base):
    __tablename__ = 'daily_ledger'
    id = Column(Integer, primary_key=True, index=True)
    project_id = Column(Integer, ForeignKey('projects.id'))
    invoice_id = Column(Integer, ForeignKey('invoices_log.id'))
    boq_item_id = Column(Integer, ForeignKey('boq_items.id'))
    entry_date = Column(Date, index=True)
    distributed_qty = Column(Float, default=0.0)
    
    project = relationship("Project", back_populates="ledger_entries")
    invoice = relationship("InvoiceLog", back_populates="invoice_entries") # ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    boq_item = relationship("BOQItem", back_populates="ledger_entries")
    
    # ØªØµØ­ÙŠØ­ Ø¹Ù„Ø§Ù‚Ø© invoice ÙÙŠ DailyLedger Ù„ØªØ·Ø§Ø¨Ù‚ InvoiceLog
    invoice = relationship("InvoiceLog", back_populates="ledger_entries")

==================================================
FILE: README_DB.md
==================================================
# Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

## ğŸ¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)

Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„:

```bash
python init_db.py
```

Ù‡Ø°Ø§ Ø³ÙŠÙ†Ø´Ø¦ Ù…Ù„Ù `construction_system.db` Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„.

**âš ï¸ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹:** Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ØŒ **Ø§Ø­Ø°Ù** Ø£Ùˆ Ø§Ø¹Ù…Ù„ comment Ù„Ù„Ù…Ù„Ù `init_db.py` Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø§ ØªØ´ØºÙ„Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!

---

## ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Alembic Ù„Ù„Ù€ Migrations (Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù„Ù„Ø¥Ù†ØªØ§Ø¬)

### 1. ØªØ«Ø¨ÙŠØª Alembic

```bash
pip install alembic
```

### 2. ØªÙ‡ÙŠØ¦Ø© Alembic

```bash
alembic init alembic
```

### 3. ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù `alembic.ini`

Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø·Ø±:
```ini
sqlalchemy.url = driver://user:pass@localhost/dbname
```

ÙˆØ§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ù€:
```ini
sqlalchemy.url = sqlite:///construction_system.db
```

### 4. ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù `alembic/env.py`

Ø£Ø¶Ù ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù:
```python
from database import Base
import models  # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ models
target_metadata = Base.metadata
```

### 5. Ø¥Ù†Ø´Ø§Ø¡ Migration Ø¬Ø¯ÙŠØ¯

ÙƒÙ„ Ù…Ø§ ØªØ¹Ø¯Ù„ ÙÙŠ Ø§Ù„Ù€ modelsØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ migration:

```bash
alembic revision --autogenerate -m "ÙˆØµÙ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"
```

### 6. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ Migration

```bash
alembic upgrade head
```

### 7. Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Migration (Ù„Ùˆ Ù„Ø²Ù…)

```bash
alembic downgrade -1
```

---

## ğŸ“ Ù…Ø«Ø§Ù„: Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯

### Ø§Ù„Ø®Ø·ÙˆØ§Øª:

1. Ø¹Ø¯Ù„ Ø§Ù„Ù€ model ÙÙŠ `models.py`:
```python
class Project(Base):
    __tablename__ = 'projects'
    id = Column(Integer, primary_key=True)
    name = Column(String, nullable=False)
    budget = Column(Float, default=0.0)  # â† Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯
```

2. Ø£Ù†Ø´Ø¦ migration:
```bash
alembic revision --autogenerate -m "add budget to projects"
```

3. Ø·Ø¨Ù‚ Ø§Ù„ØªØºÙŠÙŠØ±:
```bash
alembic upgrade head
```

**âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¢Ù…Ù†Ø© ÙˆÙ„Ù† ØªÙØ­Ø°Ù!**

---

## âš ï¸ ØªØ­Ø°ÙŠØ±Ø§Øª Ù…Ù‡Ù…Ø©

1. **Ù„Ø§ ØªØ³ØªØ®Ø¯Ù…** `Base.metadata.create_all()` ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
2. **Ù„Ø§ ØªØ´ØºÙ„** `init_db.py` Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©
3. **Ø§Ø³ØªØ®Ø¯Ù…** Alembic migrations Ù„Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©
4. **Ø§Ø¹Ù…Ù„ Backup** Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø£ÙŠ migration

---

## ğŸ” ÙØ­Øµ Ø§Ù„Ù€ Migrations Ø§Ù„Ø­Ø§Ù„ÙŠØ©

```bash
alembic current
alembic history
```

---

## ğŸ†˜ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Backup

Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£:
1. Ø§Ø­Ø°Ù Ù…Ù„Ù `construction_system.db`
2. Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
3. Ø£Ùˆ Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ `init_db.py` ÙˆØ£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯ÙŠØ¯


==================================================
FILE: requirements.txt
==================================================
fastapi
uvicorn
sqlalchemy
pandas
openpyxl
python-multipart
pydantic


==================================================
FILE: schemas.py
==================================================
from pydantic import BaseModel
from typing import List, Optional
from datetime import date
from enum import Enum

# Shared Enums
class InvoiceStatusEnum(str, Enum):
    DRAFT = "draft"
    REVIEW = "review"
    APPROVED = "approved"

# ---------------------------------------
# 1. Projects & BOQ
# ---------------------------------------
class BOQItemBase(BaseModel):
    item_code: str
    description: str
    unit: str             # ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
    unit_price: float
    is_partial: bool = False

class BOQItemCreate(BOQItemBase):
    pass

class BOQItemRead(BOQItemBase):
    id: int
    class Config:
        from_attributes = True

class ProjectCreate(BaseModel):
    name: str
    location: Optional[str] = None  # ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©

class ProjectRead(ProjectCreate):
    id: int
    boq_items: List[BOQItemRead] = []
    class Config:
        from_attributes = True

# ---------------------------------------
# 2. Invoice Details
# ---------------------------------------
class InvoiceDetailBase(BaseModel):
    boq_item_id: int
    row_description: Optional[str] = None
    current_percentage: float = 100.0
    claimed_qty: float = 0.0
    approved_qty: float = 0.0
    notes: Optional[str] = None

class InvoiceDetailRead(InvoiceDetailBase):
    id: int
    equivalent_qty: float
    previous_cumulative_qty: float
    total_cumulative_qty: float
    total_value: float
    
    class Config:
        from_attributes = True

# ---------------------------------------
# 3. Invoice Log
# ---------------------------------------
class InvoiceLogBase(BaseModel):
    project_id: int
    invoice_number: int
    period_start: date
    period_end: date
    status: InvoiceStatusEnum = InvoiceStatusEnum.DRAFT

class InvoiceLogCreate(InvoiceLogBase):
    previous_invoice_id: Optional[int] = None

class InvoiceLogRead(InvoiceLogBase):
    id: int
    details: List[InvoiceDetailRead] = []

    class Config:
        from_attributes = True

==================================================
FILE: services\invoice_processor.py
==================================================
import pandas as pd
import re
from sqlalchemy.orm import Session
from sqlalchemy import desc
from datetime import date, timedelta

from models import (
    InvoiceLog,
    InvoiceDetail,
    BOQItem,
    DailyLedger,
    Project,
    InvoiceStatus,
    StagingInvoiceDetail,
    # ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ TradeType Ù„Ùˆ Ø¹Ù…Ù„ØªÙ‡ EnumØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù†ØµÙˆØµ Ø¹Ø§Ø¯ÙŠØ©
)

def _parse_float(value, default: float = 0.0) -> float:
    """Helper: ÙŠØ­ÙˆÙ„ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù†ØµÙŠØ© Ù„Ø±Ù‚Ù… Float Ø¨Ø£Ù…Ø§Ù†."""
    if value is None:
        return default
    if isinstance(value, (int, float)):
        return float(value)
    s = str(value).strip()
    if not s or s.lower() == "nan":
        return default
    s = s.replace("%", "").strip().replace(",", "")
    try:
        return float(s)
    except ValueError:
        return default

def extract_phase_from_text(text):
    """ÙŠÙØµÙ„ Ø§Ù„ÙˆØµÙ Ø¹Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ù…Ø§ Ø¨ÙŠÙ† Ø§Ù„Ù‚ÙˆØ³ÙŠÙ†)."""
    if text is None: return "", ""
    clean_text = str(text).strip()
    if not clean_text or clean_text.lower() == 'nan': return "", ""

    pattern = r"\((.*?)\)$"
    match = re.search(pattern, clean_text)
    
    if match:
        phase = match.group(1).strip()
        main_desc = clean_text[:match.start()].strip()
        return main_desc, phase
    
    return clean_text, "ÙƒØ§Ù…Ù„"

def process_excel_invoice(
    db: Session,
    project_id: int,
    file_path: str,
    inv_number: str | int,
    start_date: date,
    end_date: date,
    sheet_name: str = 0,
    trade_type: str = "general"  # Ù…Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ®ØµØµ (Ù…Ø¯Ù†ÙŠ/ÙƒÙ‡Ø±Ø¨Ø§Ø¡)
):
    """
    Phase 1: STAGING with Merge Logic
    ÙŠØ³Ù…Ø­ Ø¨Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (Ù…Ø¯Ù†ÙŠØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡) Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.
    """
    
    # 1. Validation: Project exists
    project = db.query(Project).filter(Project.id == project_id).first()
    if not project:
        raise ValueError(f"Project with id={project_id} not found")

    try:
        invoice_number_int = int(inv_number)
    except (TypeError, ValueError):
        raise ValueError("invoice_number must be convertible to integer")

    # --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ (Merge Logic) ---
    existing_invoice = db.query(InvoiceLog).filter(
        InvoiceLog.project_id == project_id,
        InvoiceLog.invoice_number == invoice_number_int
    ).first()

    current_invoice_id = None

    if existing_invoice:
        # Ù„Ùˆ Ù…Ø¹ØªÙ…Ø¯ØŒ Ù†Ø±ÙØ¶ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if existing_invoice.status == InvoiceStatus.APPROVED:
            raise ValueError(
                f"ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ({invoice_number_int}) Ù…Ø¹ØªÙ…Ø¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„ÙŠÙ‡."
            )
        
        # Ù„Ùˆ Ù…Ø³ÙˆØ¯Ø© (Draft)ØŒ Ù†Ø³ØªØ®Ø¯Ù…Ù‡
        current_invoice_id = existing_invoice.id
        
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„ØªØ´Ù…Ù„ Ø£ÙˆØ³Ø¹ Ù†Ø·Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        existing_invoice.period_start = start_date
        existing_invoice.period_end = end_date
        
        # Ù‡Ø§Ù…: Ù†Ù…Ø³Ø­ ÙÙ‚Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Staging Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ "Ù†ÙØ³ Ø§Ù„ØªØ®ØµØµ" 
        # Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¨Ø±ÙØ¹ "Ù…Ø¯Ù†ÙŠ" ØªØ§Ù†ÙŠ (ØªØ¹Ø¯ÙŠÙ„)ØŒ ÙŠÙ…Ø³Ø­ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø³ ÙˆÙŠØ³ÙŠØ¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡
        # (ÙŠØªØ·Ù„Ø¨ ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ trade ÙÙŠ StagingInvoiceDetail)
        try:
            db.query(StagingInvoiceDetail).filter(
                StagingInvoiceDetail.invoice_id == current_invoice_id,
                StagingInvoiceDetail.trade == trade_type
            ).delete()
            db.commit()
        except Exception:
            # Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø³Ù‡ØŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£ Ù…Ø¤Ù‚ØªØ§Ù‹ (Ù„ÙƒÙ† ÙŠÙØ¶Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„)
            db.rollback()
            pass

    else:
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯ (Header)
        new_invoice = InvoiceLog(
            project_id=project_id,
            invoice_number=invoice_number_int,
            period_start=start_date,
            period_end=end_date,
            status=InvoiceStatus.DRAFT,
        )
        db.add(new_invoice)
        db.commit()
        db.refresh(new_invoice)
        current_invoice_id = new_invoice.id

    # 2. Read Excel
    try:
        df = pd.read_excel(file_path, sheet_name=sheet_name)
    except Exception as e:
        raise ValueError(f"Failed to read Excel file: {str(e)}")

    # 3. Column Mapping
    col_map = {"item_code": None, "description": None, "qty": None, "percentage": None}
    lower_cols = {str(c).strip().lower(): c for c in df.columns}

    patterns_map = {
        "item_code": ["item_code", "code", "item", "boq", "boq_code", "Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø¯", "ÙƒÙˆØ¯", "Ø±Ù‚Ù… Ø¨Ù†Ø¯", "Ø¨Ù†Ø¯"],
        "description": ["description", "desc", "ØªÙØµÙŠÙ„", "Ø§Ù„Ø¨Ù†Ø¯", "Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„", "ÙˆØµÙ", "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„"],
        "qty": ["total_qty", "qty", "quantity", "Ø§Ù„ÙƒÙ…ÙŠØ©", "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©", "Ø§Ù„Ø¬Ø§Ø±Ù‰", "Ø§Ù„Ø¬Ø§Ø±ÙŠ", "ÙƒÙ…ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¬Ø§Ø±ÙŠØ©"],
        "percentage": ["percentage", "pct", "Ù†Ø³Ø¨Ø©", "Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ±Ù", "Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ°"],
    }

    for key, patterns in patterns_map.items():
        for p in patterns:
            lp = p.lower()
            if lp in lower_cols:
                col_map[key] = lower_cols[lp]
                break

    if not col_map["item_code"] or not col_map["qty"]:
        raise ValueError(f"Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©. Ø§Ù„Ù…ØªØ§Ø­: {list(lower_cols.values())}")

    # 4. Bulk Insert into Staging
    staging_objects = []
    rows_staged = 0
    
    for idx, row in df.iterrows():
        raw_item_code = row.get(col_map["item_code"])
        
        # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ©
        if pd.isna(raw_item_code) or str(raw_item_code).strip() == "":
            continue

        raw_desc = row.get(col_map["description"])
        raw_qty = row.get(col_map["qty"])
        raw_pct = row.get(col_map["percentage"])

        staging_row = StagingInvoiceDetail(
            invoice_id=current_invoice_id,
            row_index=int(idx),
            raw_item_code=str(raw_item_code).strip(),
            raw_description=str(raw_desc).strip() if pd.notna(raw_desc) else "",
            raw_qty=str(raw_qty).strip() if pd.notna(raw_qty) else "",
            raw_percentage=str(raw_pct).strip() if pd.notna(raw_pct) else "",
            
            trade=trade_type,  # <--- Ø­ÙØ¸ Ø§Ù„ØªØ®ØµØµ (Ù…Ø¯Ù†ÙŠ/ÙƒÙ‡Ø±Ø¨Ø§Ø¡)
            
            is_valid=False,
            error_message=None,
        )
        staging_objects.append(staging_row)
        rows_staged += 1

    if staging_objects:
        db.add_all(staging_objects)
        db.commit()

    return {
        "status": "staged",
        "invoice_id": current_invoice_id,
        "rows_staged": rows_staged,
        "trade": trade_type,
        "message": f"ØªÙ… Ø±ÙØ¹ {rows_staged} Ø¨Ù†Ø¯ ({trade_type}) Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ÙˆØ¯Ø©."
    }

def approve_invoice(db: Session, invoice_id: int):
    """
    Phase 2: APPROVAL & LEDGER
    ÙŠÙ‚ÙˆÙ… Ø¨Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Staging Ø¥Ù„Ù‰ Details ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù€ Ledger
    """
    
    invoice = db.query(InvoiceLog).filter(InvoiceLog.id == invoice_id).first()
    if not invoice:
        raise ValueError("Invoice not found")

    if invoice.status == InvoiceStatus.APPROVED:
        raise ValueError("Invoice is already approved")

    staging_rows = invoice.staging_data
    if not staging_rows:
        raise ValueError("No staging rows found")

    # Time Calculation
    start_date = invoice.period_start
    end_date = invoice.period_end
    total_days = (end_date - start_date).days + 1
    if total_days <= 0:
        total_days = 1 # Fallback to prevent division by zero

    # Clean old data (Full clear for this invoice ID)
    # ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
    db.query(DailyLedger).filter(DailyLedger.invoice_id == invoice.id).delete()
    db.query(InvoiceDetail).filter(InvoiceDetail.invoice_id == invoice.id).delete()

    processed_count = 0
    errors_found = 0

    for s in staging_rows:
        s.is_valid = False
        s.error_message = None

        raw_item_code = s.raw_item_code.strip()
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ù†Ø¯ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§ÙŠØ³Ø©
        boq_item = (
            db.query(BOQItem)
            .filter(
                BOQItem.project_id == invoice.project_id,
                BOQItem.item_code == raw_item_code,
            )
            .first()
        )
        
        if not boq_item:
            s.error_message = f"ÙƒÙˆØ¯ Ø§Ù„Ø¨Ù†Ø¯ '{raw_item_code}' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§ÙŠØ³Ø©"
            errors_found += 1
            continue # ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„ÙƒÙ† Ù„Ø§ ØªÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙƒÙ„Ù‡Ø§

        # Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        claimed_qty = _parse_float(s.raw_qty, 0.0)
        current_percentage = _parse_float(s.raw_percentage, 100.0)
        approved_qty = claimed_qty
        equivalent_qty = approved_qty * (current_percentage / 100.0)

        # Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚ (Complex Logic)
        last_cumulative_record = (
            db.query(InvoiceDetail)
            .join(InvoiceLog)
            .filter(
                InvoiceLog.project_id == invoice.project_id,
                InvoiceLog.status == InvoiceStatus.APPROVED,
                InvoiceLog.id < invoice.id,
                InvoiceDetail.boq_item_id == boq_item.id,
            )
            .order_by(desc(InvoiceLog.id))
            .first()
        )

        previous_cumulative_qty = last_cumulative_record.total_cumulative_qty if last_cumulative_record else 0.0
        total_cumulative_qty = previous_cumulative_qty + equivalent_qty
        
        unit_price = boq_item.unit_price or 0.0
        total_value = equivalent_qty * unit_price

        main_desc_text, phase_name = extract_phase_from_text(s.raw_description)
        final_desc = phase_name or main_desc_text or "Ø¨Ù†Ø¯ ÙƒØ§Ù…Ù„"

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø¯ÙØªØ± Ø§Ù„Ù†Ø¸ÙŠÙ
        detail = InvoiceDetail(
            invoice_id=invoice.id,
            boq_item_id=boq_item.id,
            row_description=final_desc,
            current_percentage=current_percentage,
            claimed_qty=claimed_qty,
            approved_qty=approved_qty,
            equivalent_qty=equivalent_qty,
            previous_cumulative_qty=previous_cumulative_qty,
            total_cumulative_qty=total_cumulative_qty,
            unit_price_at_time=unit_price,
            total_value=total_value,
            
            trade=s.trade # <--- Ù†Ù‚Ù„ Ø§Ù„ØªØ®ØµØµ Ù…Ù† Ø§Ù„Ù€ Staging
        )
        db.add(detail)

        # Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø²Ù…Ù†ÙŠ (Ledger)
        if equivalent_qty != 0:
            daily_rate = equivalent_qty / total_days
            ledger_entries = [
                DailyLedger(
                    project_id=invoice.project_id,
                    invoice_id=invoice.id,
                    boq_item_id=boq_item.id,
                    entry_date=start_date + timedelta(days=i),
                    distributed_qty=daily_rate,
                )
                for i in range(total_days)
            ]
            db.add_all(ledger_entries)

        s.is_valid = True
        s.error_message = "Success"
        processed_count += 1

    # Ù„Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø¥Ù„Ø§ Ù„Ùˆ Ù…ÙÙŠØ´ Ø£Ø®Ø·Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù…Ù…ÙƒÙ† ØªØ¹ØªÙ…Ø¯Ù‡ Ø¬Ø²Ø¦ÙŠØ§Ù‹)
    # Ù‡Ù†Ø§ Ø³Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ³Ù†ØªØ±Ùƒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù€ Staging Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
    invoice.status = InvoiceStatus.APPROVED
    db.commit()

    return {
        "status": "approved",
        "invoice_id": invoice.id,
        "processed_items": processed_count,
        "errors": errors_found,
        "message": f"ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯. ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© {processed_count} Ø¨Ù†Ø¯ØŒ ÙˆÙˆØ¬Ø¯ {errors_found} Ø£Ø®Ø·Ø§Ø¡."
    }
